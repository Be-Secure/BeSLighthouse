import * as React from "react";
import Grid from "@mui/material/Grid";
import Card from "@mui/material/Card";

import { projectOfInterestData } from "../../utils/poi_data";
import DefaultNavbar from "../../examples/Navbars/DefaultNavbar";
import MKBox from "../../components/MKBox";
import routes from "../../routes";
import VulnerablitiDisplay from "./VulnerablitiDisplay";

export const fetchOsspoiMaterData = async () => {
  const osspoi: any = JSON.parse(
    await projectOfInterestData.getJsonReportOsspoiMaster()
  );
  projectOfInterestData.updateDataPoi("Project_of_interest", osspoi.items);
  return osspoi;
};

async function countLanguages(
  setData: React.Dispatch<React.SetStateAction<never[]>>,
  setTecStack: React.Dispatch<React.SetStateAction<never[]>>,
  cache: any
) {
  let supportedLanguages: any = {
    python: true,
    java: true,
    javascript: true,
    c: true,
    "c++": true,
    php: true,
  };
  const tecStackForChart: any = [];
  const osspoi = await fetchOsspoiMaterData();
  let languageCount: any = {};
  let besTecStack: any = {};
  for (let i = 0; i < osspoi.items.length; i++) {
    if (!besTecStack[osspoi.items[i]["bes_technology_stack"]]) {
      besTecStack[osspoi.items[i]["bes_technology_stack"]] = 0;
    }
    besTecStack[osspoi.items[i]["bes_technology_stack"]]++;
    for (let language of Object.keys(osspoi.items[i].language)) {
      const lan: string = language.toLocaleLowerCase().trim();
      if (supportedLanguages[lan]) {
        if (!languageCount[lan]) {
          languageCount[lan] = 1;
          continue;
        }
        languageCount[lan]++;
      }
    }
  }
  for (let tecStack of Object.keys(besTecStack)) {
    tecStackForChart.push({ label: tecStack, value: besTecStack[tecStack] });
  }
  for (let language of Object.keys(languageCount)) {
    cache.push({ label: language, value: languageCount[language] });
  }
  setTecStack(tecStackForChart);
  setData(cache);
}

function VulnerabilityOfInterest() {
  const [data, setData] = React.useState([]);
  const [tecStack, setTecStack] = React.useState([]);
  React.useEffect(() => {
    countLanguages(setData, setTecStack, []);
  }, []);

  return (
    <>
      <DefaultNavbar routes={routes} sticky />
      <MKBox minHeight="12vh" width="100%"></MKBox>
      <MKBox sx={{mx: { xs: 2, lg: 3 }}}>
        <Grid container spacing={6}>
          <Grid item xs={12}>
            <Card>
              <MKBox>
                <VulnerablitiDisplay />
              </MKBox>
            </Card>
          </Grid>
        </Grid>
      </MKBox>
    </>
  );
}

export default VulnerabilityOfInterest;
