 
import { filter } from "lodash";
import React, { useState } from "react";
import { getComparator } from "../../ProjectOfInterest/ProjectDisplay";
import SearchVoiList from "../VoiTable/SearchVoiList";
import VulnerabilityTable from "../VoiTable/VulnerabilityTable";
import { ecoSystem, filterCheck } from "../filter/references";

function applySortFilter(array: any, comparator: any, query: any) {
  const stabilizedThis = array.map((el: any, index: any) => [el, index]);
  stabilizedThis.sort((a: any, b: any) => {
    const order = comparator(a[0], b[0]);
    if (order !== 0) return order;
    return a[1] - b[1];
  });
  if (query) {
    const search = query.trim();
    return filter(array, (_user: any) => {
      if (_user.id.toString().indexOf(search.toString()) !== -1) return true;
      if (_user.cve_id.trim().toString().indexOf(search.toString()) !== -1)
        return true;
      const result = _user.aliases.filter(
         
        (cve: string) => cve.toLowerCase().includes(search.toLowerCase())
      );
      return result.length !== 0;
    });
  }
  return stabilizedThis.map((el: any) => el[0]);
}

function filterDataBasedOnUserSelecrtionOnEcoSystem(
  ecoSystem: string,
  getVoiLIST: any[]
): any {
  const regex = /^([^:]+)/gm;
  const filteredArray = getVoiLIST.filter((obj) => {
    return obj.affected.some(
      (item: { package: { ecosystem: { match: (arg0: RegExp) => string[]; }; }; }) => {
        return item.package.ecosystem.match(regex)[0] === ecoSystem;
      }
    );
  }
  );
  return filteredArray;
}

export default function VulnerablitiDisplay({ report, selectedFilter }: any) {
  const [filterName, setFilterName] = useState("");
  const handleFilterByName = (event: any) => {
    setFilterName(event.target.value);
  };

  let getVoiLIST: any = report;

  if (selectedFilter?.EcoSystem && !filterCheck[selectedFilter?.EcoSystem]) {
    getVoiLIST = filterDataBasedOnUserSelecrtionOnEcoSystem(
      ecoSystem[selectedFilter?.EcoSystem],
      getVoiLIST
    );
  }

  if (selectedFilter?.Fix === "No Fix Available") {
    getVoiLIST = [];
  }

  const filteredCveReport = applySortFilter(
    getVoiLIST,
    getComparator("desc", "id"),
    filterName
  );

  return (
    <>
      <SearchVoiList
        placeholderName="Package or ID search"
        filterName={ filterName }
        onFilterName={ handleFilterByName }
      />
      <VulnerabilityTable data={ filteredCveReport } />
    </>
  );
}
