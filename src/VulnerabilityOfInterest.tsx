import * as React from "react";
import SiteWrapper from "./SiteWrapper";

import { PoiListToolbar } from "./components/PoiTable";
import { useState } from "react";
import { Card, Container } from "@mui/material";
import Vulnerability from "./report/vulnerability/Vulnerability";
import { vulnerabilityOffInterest } from "./data-store/dataStore";
import { verifyLink } from "./sections/AssessmentReport";
import { filter } from "lodash";
import { getComparator } from "./ProjectOfInterestTrack";
import Page from "./components/Page";

function applySortFilter(array: any, comparator: any, query: any) {
  const stabilizedThis = array.map((el: any, index: any) => [el, index]);
  stabilizedThis.sort((a: any, b: any) => {
    const order = comparator(a[0], b[0]);
    if (order !== 0) return order;
    return a[1] - b[1];
  });
  if (query) {
    return filter(
      array,
      (_user: any) =>{
        if (_user.id.toString().indexOf(query.toString()) !== -1) return true;
        const result = _user.aliases.filter((cve: string) => cve.toLowerCase().indexOf(query.toLowerCase()) !== -1);
        return result.length !== 0;
      }
    );
  }
  return stabilizedThis.map((el: any) => el[0]);
}

function VulnerabilityOfInterest() {
  const [filterName, setFilterName] = useState("");
  const handleFilterByName = (event: any) => {
    setFilterName(event.target.value);
  };

  const [report, setreport]: any = useState([]);
  React.useEffect(() => {
    verifyLink(vulnerabilityOffInterest, setreport);
  }, []);

  const filteredCveReport = applySortFilter(
    report,
    getComparator("desc", "id"),
    filterName
  );
  // const isNotFound = !filteredCveReport.length && !!filterName;
  return (
    <SiteWrapper>
      <Page.Content title="Vulnerability Library"></Page.Content>
      <Container style={{ padding: "0px", marginTop: "12px" }}>
        <Card>
          <PoiListToolbar
            placeholderName="Package or ID search"
            filterName={filterName}
            onFilterName={handleFilterByName}
          />
        </Card>
      </Container>
      <Vulnerability data={filteredCveReport} />
    </SiteWrapper>
  );
}

export default VulnerabilityOfInterest;
